<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1" />

    <title>L-System Studio</title>
  </head>
  <body>
    <div id="app"></div>
    <script src="./app.js"></script>
    <script>
      // Q: Does an OffscreenCanvas speed things up even more?
      customElements.define(
        "elm-canvas",
        class extends HTMLElement {
          constructor () {
            super();
            this.lines = [];
            this.mounted = false;
          }

          set commands (value) {
            this.lines = value;
            requestAnimationFrame(() => {
              this.render();
            });
          }

          connectedCallback () {
            requestAnimationFrame(() => {
              this.canvas = this.querySelector("canvas");
              this.ctx = this.canvas.getContext("2d");
              this.mounted = true;

              this.setCanvasDimensions();
              this.render();
            });
          }

          setCanvasDimensions() {
            if (!this.mounted) return;

            var width = Number(this.getAttribute("width") || this.canvas.getAttribute("width"));
            var height = Number(this.getAttribute("height") || this.canvas.getAttribute("height"));

            var devicePixelRatio = window.devicePixelRatio || 1;
            this.canvas.style.width = width + "px";
            this.canvas.style.height = height + "px";
            this.canvas.width = width * devicePixelRatio;
            this.canvas.height = height * devicePixelRatio;
            // Reset current transformation matrix to the identity matrix
            this.ctx.setTransform(1, 0, 0, 1, 0, 0);
            this.ctx.scale(devicePixelRatio, devicePixelRatio);
          }

          render() {
            if (!this.mounted) return;

            this.ctx.beginPath();
            this.lines.forEach(({ x1, y1, x2, y2 }) => {
              this.ctx.moveTo(x1, y1);
              this.ctx.lineTo(x2, y2);
            });
            this.ctx.stroke();
          }
        }
      );

      const app = Elm.Main.init({
        node: document.getElementById("app")
      });
    </script>
  </body>
</html>
